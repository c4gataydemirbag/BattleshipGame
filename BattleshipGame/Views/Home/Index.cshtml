@{
    ViewData["Title"] = "Battleship - Final UI";
}

<style>
    body {
        background-color: #2c3e50;
        color: white;
        user-select: none;
        font-family: 'Segoe UI', sans-serif;
        overflow: hidden;
    }

    .game-container {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-top: 30px;
    }

    .game-board {
        display: grid;
        grid-template-columns: repeat(10, 40px);
        grid-template-rows: repeat(10, 40px);
        gap: 2px;
        background-color: #34495e;
        border: 4px solid #ecf0f1;
        padding: 2px;
    }

    .cell {
        width: 40px;
        height: 40px;
        background-color: #3498db;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 20px;
        transition: all 0.2s;
    }

    #targetBoard .cell {
        cursor: crosshair;
    }

        #targetBoard .cell:hover {
            background-color: #5dade2;
        }
    .hit, .miss {
        pointer-events: none !important;
        cursor: default !important;
    }

    .ship-cell {
        background-color: #555 !important;
        border: 2px solid #333;
    }

    .hit {
        background-color: #e74c3c !important;
        color: white;
        box-shadow: inset 0 0 10px #c0392b;
    }
    .miss {
        background-color: #ecf0f1 !important;
        opacity: 0.6;
        color: #333;
    }

    .dock-container {
        width: 220px;
        background: #ecf0f1;
        padding: 15px;
        border-radius: 8px;
        color: #333;
        height: fit-content;
    }

    .dock-ship {
        background: #7f8c8d;
        color: white;
        margin-bottom: 8px;
        padding: 8px;
        text-align: center;
        cursor: grab;
        border-radius: 4px;
        font-weight: bold;
        border: 1px solid #555;
    }

        .dock-ship:active {
            cursor: grabbing;
            opacity: 0.7;
        }

    .ship-cell[draggable="true"] {
        cursor: grab;
    }

    .hidden {
        display: none !important;
    }

    .status-badge {
        font-size: 1.2rem;
        padding: 10px 20px;
        border-radius: 50px;
    }
    #gameOverOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
     
    .result-box {
        background: white;
        padding: 40px;
        border-radius: 15px;
        text-align: center;
        color: #333;
        box-shadow: 0 0 20px rgba(255,255,255,0.2);
        animation: popIn 0.5s ease;
    }

    .result-title {
        font-size: 3rem;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .win-color {
        color: #27ae60;
    }
    .lose-color {
        color: #c0392b;
    }
    @@keyframes popIn {
        from {
            transform: scale(0.5);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>

<div id="gameOverOverlay" class="hidden">
    <div class="result-box">
        <div id="resultIcon" style="font-size: 80px;">🏆</div>
        <div id="resultTitle" class="result-title">KAZANDIN!</div>
        <p id="resultMsg">Tebrikler, rakibin tüm gemilerini batırdın.</p>
        <button class="btn btn-primary btn-lg mt-3" onclick="location.reload()">TEKRAR OYNA</button>
    </div>
</div>

<div class="container">
    <div class="text-center mb-4">
        <h2 id="statusHeader">Bağlanıyor...</h2>
        <span id="turnIndicator" class="badge bg-secondary status-badge">Bekleniyor...</span>
    </div>

    <div class="game-container">
        <div>
            <h4 class="text-center mb-2">Rakip Alanı</h4>
            <div id="targetBoard" class="game-board" style="opacity: 0.6; pointer-events: none;"></div>
        </div>

        <div class="dock-container" id="shipDock">
            <div class="text-center fw-bold mb-2">TERSANE</div>

            <div id="s4_1" class="dock-ship" draggable="true" ondragstart="drag(event)" data-size="4">AMİRAL (4 Br)</div>
            <div id="s3_1" class="dock-ship" draggable="true" ondragstart="drag(event)" data-size="3">KRUVAZÖR (3 Br)</div>
            <div id="s3_2" class="dock-ship" draggable="true" ondragstart="drag(event)" data-size="3">KRUVAZÖR (3 Br)</div>
            <div id="s2_1" class="dock-ship" draggable="true" ondragstart="drag(event)" data-size="2">HÜCUMBOT (2 Br)</div>
            <div id="s2_2" class="dock-ship" draggable="true" ondragstart="drag(event)" data-size="2">HÜCUMBOT (2 Br)</div>
            <div id="s2_3" class="dock-ship" draggable="true" ondragstart="drag(event)" data-size="2">HÜCUMBOT (2 Br)</div>
            <div id="s1_1" class="dock-ship" draggable="true" ondragstart="drag(event)" data-size="1">DENİZALTI (1 Br)</div>
            <div id="s1_2" class="dock-ship" draggable="true" ondragstart="drag(event)" data-size="1">DENİZALTI (1 Br)</div>
            <div id="s1_3" class="dock-ship" draggable="true" ondragstart="drag(event)" data-size="1">DENİZALTI (1 Br)</div>
            <div id="s1_4" class="dock-ship" draggable="true" ondragstart="drag(event)" data-size="1">DENİZALTI (1 Br)</div>

            <button id="btnReady" class="btn btn-success w-100 mt-3 hidden" onclick="hazirOl()">HAZIRIM</button>
        </div>

        <div>
            <h4 class="text-center mb-2">Senin Alanın</h4>
            <div id="myBoard" class="game-board"></div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

<script>
    const connection = new signalR.HubConnectionBuilder().withUrl("/gamehub").build();
    let myRole = "";
    let myMatrix = Array(10).fill().map(() => Array(10).fill(0));
    let placedShips = [];
    let isReady = false;
    let opponentReady = false;
    let myHealth = 20;

    createBoards();
    connection.start().catch(err => console.error(err));

    connection.on("RolAtandi", (role) => {
        myRole = role;
        document.getElementById("statusHeader").innerText = role === "Player1" ? "Oyuncu 1 (Sen)" : "Oyuncu 2 (Sen)";
        document.getElementById("turnIndicator").innerText = "Rakip Bekleniyor...";
    });

    connection.on("RakipBaglandi", () => document.getElementById("turnIndicator").innerText = "Rakip Geldi! Gemileri Yerleştir.");
    connection.on("RakipHazir", () => { opponentReady = true; checkGameStart(); });

    connection.on("SaldiriGeldi", (x, y) => {
        const cell = document.getElementById(`my-${x}-${y}`);
        let isHit = (myMatrix[x][y] === 1);

        if (isHit) {
            cell.classList.remove("ship-cell");
            cell.classList.add("hit");
            cell.innerHTML = "❌";
            myHealth--;
        } else {
            cell.classList.add("miss");
            cell.innerHTML = "⚫";
        }

        connection.invoke("SonucBildir", x, y, isHit);
        if(myHealth <= 0) connection.invoke("OyunBitti", (myRole === "Player1" ? "Player2" : "Player1"));
        setTurn(true);
    });

    connection.on("SonucGeldi", (x, y, isHit) => {
        const cell = document.getElementById(`target-${x}-${y}`);
        if (isHit) {
            cell.classList.add("hit");
            cell.innerHTML = "❌";
        } else {
            cell.classList.add("miss");
            cell.innerHTML = "⚫";
        }
        setTurn(false);
    });

    connection.on("OyunBitti", (kazanan) => {
        const overlay = document.getElementById("gameOverOverlay");
        const title = document.getElementById("resultTitle");
        const icon = document.getElementById("resultIcon");
        const msg = document.getElementById("resultMsg");

        overlay.classList.remove("hidden");

        if (kazanan === myRole) {
            title.innerText = "KAZANDIN!";
            title.className = "result-title win-color";
            icon.innerText = "🏆";
            msg.innerText = "Harika iş! Rakip donanmayı çökerttin.";
        } else {
            title.innerText = "KAYBETTİN...";
            title.className = "result-title lose-color";
            icon.innerText = "💀";
            msg.innerText = "Tüm gemilerin battı. Bir dahaki sefere!";
        }
    });

    function createBoards() {
        const target = document.getElementById("targetBoard");
        const mine = document.getElementById("myBoard");

        for(let i=0; i<10; i++) {
            for(let j=0; j<10; j++) {
                let t = document.createElement("div"); t.className="cell"; t.id=`target-${i}-${j}`;
                t.onclick = () => fireAt(i, j);
                target.appendChild(t);

                let m = document.createElement("div"); m.className="cell"; m.id=`my-${i}-${j}`;
                m.ondragover = e => e.preventDefault();
                m.ondrop = e => dropShip(e, i, j);
                m.draggable = true;
                m.ondragstart = (e) => dragFromBoard(e, i, j);
                mine.appendChild(m);
            }
        }
    }

    function drag(ev) {
        ev.dataTransfer.setData("source", "dock");
        ev.dataTransfer.setData("id", ev.target.id);
        ev.dataTransfer.setData("size", ev.target.getAttribute("data-size"));
    }

    function dragFromBoard(ev, row, col) {
        if(isReady) { ev.preventDefault(); return; }
        if(myMatrix[row][col] === 0) { ev.preventDefault(); return; }

        const cell = ev.target;
        ev.dataTransfer.setData("source", "board");
        ev.dataTransfer.setData("shipId", cell.getAttribute("data-ship-id"));
        ev.dataTransfer.setData("size", parseInt(cell.getAttribute("data-ship-size")));
        ev.dataTransfer.setData("oldRow", parseInt(cell.getAttribute("data-start-row")));
        ev.dataTransfer.setData("oldCol", parseInt(cell.getAttribute("data-start-col")));
    }

    function dropShip(ev, row, col) {
        ev.preventDefault();
        if(isReady) return;

        const source = ev.dataTransfer.getData("source");
        const size = parseInt(ev.dataTransfer.getData("size"));

        if (source === "board") {
            const oldRow = parseInt(ev.dataTransfer.getData("oldRow"));
            const oldCol = parseInt(ev.dataTransfer.getData("oldCol"));
            const shipId = ev.dataTransfer.getData("shipId");

            for(let k=0; k<size; k++) myMatrix[oldRow][oldCol+k] = 0;

            if (isValid(row, col, size)) {
                paintShip(row, col, size, shipId);
                for(let k=0; k<size; k++) {
                    const c = document.getElementById(`my-${oldRow}-${oldCol+k}`);
                    c.classList.remove("ship-cell");
                    c.removeAttribute("data-ship-id");
                }
            } else {
                for(let k=0; k<size; k++) myMatrix[oldRow][oldCol+k] = 1;
            }
        } else {
            const id = ev.dataTransfer.getData("id");
            if (isValid(row, col, size)) {
                paintShip(row, col, size, id);
                document.getElementById(id).style.display = "none";
                placedShips.push(id);
                if(placedShips.length === 10) document.getElementById("btnReady").classList.remove("hidden");
            }
        }
    }

    function isValid(row, col, size) {
        if(col + size > 10) return false;
        for(let k=0; k<size; k++) if(myMatrix[row][col+k] === 1) return false;
        return true;
    }

    function paintShip(row, col, size, id) {
        for(let k=0; k<size; k++) {
            myMatrix[row][col+k] = 1;
            const cell = document.getElementById(`my-${row}-${col+k}`);
            cell.classList.add("ship-cell");
            cell.setAttribute("data-ship-id", id);
            cell.setAttribute("data-ship-size", size);
            cell.setAttribute("data-start-row", row);
            cell.setAttribute("data-start-col", col);
        }
    }

    function hazirOl() {
        isReady = true;
        document.getElementById("btnReady").classList.add("hidden");
        document.getElementById("shipDock").classList.add("hidden");
        document.getElementById("statusHeader").innerText = "Rakip Bekleniyor...";
        connection.invoke("Hazirim");
        checkGameStart();
    }

    function checkGameStart() {
        if(isReady && opponentReady) {
            document.getElementById("statusHeader").innerText = "SAVAŞ BAŞLADI";
            setTurn(myRole === "Player1");
        }
    }

    function setTurn(isMine) {
        const ind = document.getElementById("turnIndicator");
        const board = document.getElementById("targetBoard");
        if(isMine) {
            ind.innerText = "SIRA SENDE! ATEŞ ET";
            ind.className = "badge bg-success status-badge";
            board.style.opacity = "1";
            board.style.pointerEvents = "auto";
        } else {
            ind.innerText = "RAKİP DÜŞÜNÜYOR...";
            ind.className = "badge bg-danger status-badge";
            board.style.opacity = "0.6";
            board.style.pointerEvents = "none";
        }
    }

    function fireAt(x, y) {
        const cell = document.getElementById(`target-${x}-${y}`);

        if (cell.classList.contains("hit") || cell.classList.contains("miss")) return;

        connection.invoke("AtesEt", x, y);
        document.getElementById("targetBoard").style.pointerEvents = "none";
    }
</script>